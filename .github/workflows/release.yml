name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build Release Binaries
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # Linux
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          # macOS
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          # Windows
          - goos: windows
            goarch: amd64
          - goos: windows
            goarch: arm64
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION=$(git describe --tags --always --dirty)
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"

      - name: Build binary
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          VERSION=${{ steps.version.outputs.version }}
          BINARY_NAME="dudu-proxy-${VERSION}-${GOOS}-${GOARCH}"
          
          # Add .exe suffix for Windows
          if [ "$GOOS" = "windows" ]; then
            BINARY_NAME="${BINARY_NAME}.exe"
          fi
          
          echo "Building ${BINARY_NAME}..."
          
          go build \
            -ldflags "-s -w -X main.version=${VERSION}" \
            -trimpath \
            -o "build/${BINARY_NAME}" \
            main.go
          
          echo "binary_name=${BINARY_NAME}" >> $GITHUB_OUTPUT
          
          # Show build info
          ls -lh "build/${BINARY_NAME}"
          file "build/${BINARY_NAME}"
        id: build

      - name: Create ZIP archive
        run: |
          cd build
          BINARY_NAME="${{ steps.build.outputs.binary_name }}"
          ZIP_NAME="${BINARY_NAME}.zip"
          
          # Create ZIP archive
          zip "${ZIP_NAME}" "${BINARY_NAME}"
          
          echo "zip_name=${ZIP_NAME}" >> $GITHUB_OUTPUT
          echo "Created ${ZIP_NAME}"
          ls -lh "${ZIP_NAME}"
        id: zip

      - name: Generate checksums
        run: |
          cd build
          sha256sum "${{ steps.build.outputs.binary_name }}" > "${{ steps.build.outputs.binary_name }}.sha256"
          sha256sum "${{ steps.zip.outputs.zip_name }}" > "${{ steps.zip.outputs.zip_name }}.sha256"
          
          echo "Binary checksum:"
          cat "${{ steps.build.outputs.binary_name }}.sha256"
          echo "ZIP checksum:"
          cat "${{ steps.zip.outputs.zip_name }}.sha256"

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.binary_name }}
          path: |
            build/${{ steps.build.outputs.binary_name }}
            build/${{ steps.build.outputs.binary_name }}.sha256
            build/${{ steps.zip.outputs.zip_name }}
            build/${{ steps.zip.outputs.zip_name }}.sha256
          retention-days: 1

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION=$(git describe --tags --always --dirty)
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release files
        run: |
          mkdir -p release
          
          # Move all binaries and checksums to release directory
          find artifacts -type f -exec mv {} release/ \;
          
          # Generate combined checksums file
          cd release
          sha256sum dudu-proxy-* | grep -v ".sha256" > checksums.txt
          
          echo "Release files:"
          ls -lh
          
          echo -e "\nChecksums:"
          cat checksums.txt

      - name: Read release notes
        id: release_notes
        run: |
          if [ -f "RELEASE_NOTES.md" ]; then
            echo "Using RELEASE_NOTES.md for release description"
            NOTES=$(cat RELEASE_NOTES.md)
          else
            echo "Generating default release notes"
            NOTES="Release ${{ steps.version.outputs.version }}"
          fi
          
          # Use multiline output
          {
            echo 'notes<<EOF'
            echo "$NOTES"
            echo EOF
          } >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ steps.version.outputs.version }}
          body: |
            ${{ steps.release_notes.outputs.notes }}
            
            ## ðŸ“¦ Downloads
            
            Choose the version for your system:
            
            ### Linux
            - Binary: [dudu-proxy-${{ steps.version.outputs.version }}-linux-amd64](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/dudu-proxy-${{ steps.version.outputs.version }}-linux-amd64)
            - ZIP: [dudu-proxy-${{ steps.version.outputs.version }}-linux-amd64.zip](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/dudu-proxy-${{ steps.version.outputs.version }}-linux-amd64.zip)
            - Binary: [dudu-proxy-${{ steps.version.outputs.version }}-linux-arm64](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/dudu-proxy-${{ steps.version.outputs.version }}-linux-arm64)
            - ZIP: [dudu-proxy-${{ steps.version.outputs.version }}-linux-arm64.zip](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/dudu-proxy-${{ steps.version.outputs.version }}-linux-arm64.zip)
            
            ### macOS
            - Binary: [dudu-proxy-${{ steps.version.outputs.version }}-darwin-amd64](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/dudu-proxy-${{ steps.version.outputs.version }}-darwin-amd64) (Intel)
            - ZIP: [dudu-proxy-${{ steps.version.outputs.version }}-darwin-amd64.zip](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/dudu-proxy-${{ steps.version.outputs.version }}-darwin-amd64.zip)
            - Binary: [dudu-proxy-${{ steps.version.outputs.version }}-darwin-arm64](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/dudu-proxy-${{ steps.version.outputs.version }}-darwin-arm64) (Apple Silicon)
            - ZIP: [dudu-proxy-${{ steps.version.outputs.version }}-darwin-arm64.zip](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/dudu-proxy-${{ steps.version.outputs.version }}-darwin-arm64.zip)
            
            ### Windows
            - Binary: [dudu-proxy-${{ steps.version.outputs.version }}-windows-amd64.exe](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/dudu-proxy-${{ steps.version.outputs.version }}-windows-amd64.exe)
            - ZIP: [dudu-proxy-${{ steps.version.outputs.version }}-windows-amd64.exe.zip](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/dudu-proxy-${{ steps.version.outputs.version }}-windows-amd64.exe.zip)
            - Binary: [dudu-proxy-${{ steps.version.outputs.version }}-windows-arm64.exe](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/dudu-proxy-${{ steps.version.outputs.version }}-windows-arm64.exe)
            - ZIP: [dudu-proxy-${{ steps.version.outputs.version }}-windows-arm64.exe.zip](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/dudu-proxy-${{ steps.version.outputs.version }}-windows-arm64.exe.zip)
            
            ## âœ… Checksum Verification
            
            Download [checksums.txt](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/checksums.txt) to verify file integrity:
            
            ```bash
            # Linux/macOS
            sha256sum -c checksums.txt
            
            # macOS (alternative)
            shasum -a 256 -c checksums.txt
            
            # Windows (PowerShell)
            Get-FileHash dudu-proxy-*.exe -Algorithm SHA256
            ```
          files: |
            release/*
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
