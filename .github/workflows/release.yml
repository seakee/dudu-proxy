name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    name: Build Release Binaries
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # Linux
          - goos: linux
            goarch: amd64
          - goos: linux
            goarch: arm64
          # macOS
          - goos: darwin
            goarch: amd64
          - goos: darwin
            goarch: arm64
          # Windows
          - goos: windows
            goarch: amd64
          - goos: windows
            goarch: arm64
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è®¾ç½® Go ç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          cache: true

      - name: è·å–ç‰ˆæœ¬å·
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION=$(git describe --tags --always --dirty)
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "Building version: ${VERSION}"

      - name: æ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶
        env:
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
          CGO_ENABLED: 0
        run: |
          VERSION=${{ steps.version.outputs.version }}
          BINARY_NAME="dudu-proxy-${VERSION}-${GOOS}-${GOARCH}"
          
          # Windows éœ€è¦ .exe åç¼€
          if [ "$GOOS" = "windows" ]; then
            BINARY_NAME="${BINARY_NAME}.exe"
          fi
          
          echo "Building ${BINARY_NAME}..."
          
          go build \
            -ldflags "-s -w -X main.version=${VERSION}" \
            -trimpath \
            -o "build/${BINARY_NAME}" \
            main.go
          
          echo "binary_name=${BINARY_NAME}" >> $GITHUB_OUTPUT
          
          # æ˜¾ç¤ºæ„å»ºä¿¡æ¯
          ls -lh "build/${BINARY_NAME}"
          file "build/${BINARY_NAME}"
        id: build

      - name: ç”Ÿæˆæ ¡éªŒå’Œ
        run: |
          cd build
          sha256sum "${{ steps.build.outputs.binary_name }}" > "${{ steps.build.outputs.binary_name }}.sha256"
          cat "${{ steps.build.outputs.binary_name }}.sha256"

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build.outputs.binary_name }}
          path: |
            build/${{ steps.build.outputs.binary_name }}
            build/${{ steps.build.outputs.binary_name }}.sha256
          retention-days: 1

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: è·å–ç‰ˆæœ¬å·
        id: version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION=$(git describe --tags --always --dirty)
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: æ•´ç†å‘å¸ƒæ–‡ä»¶
        run: |
          mkdir -p release
          
          # ç§»åŠ¨æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶å’Œæ ¡éªŒå’Œåˆ° release ç›®å½•
          find artifacts -type f -exec mv {} release/ \;
          
          # ç”Ÿæˆæ€»æ ¡éªŒå’Œæ–‡ä»¶
          cd release
          sha256sum dudu-proxy-* | grep -v ".sha256" > checksums.txt
          
          echo "Release files:"
          ls -lh
          
          echo -e "\nChecksums:"
          cat checksums.txt

      - name: è¯»å–å‘å¸ƒè¯´æ˜
        id: release_notes
        run: |
          if [ -f "RELEASE_NOTES.md" ]; then
            echo "ä½¿ç”¨ RELEASE_NOTES.md ä½œä¸ºå‘å¸ƒè¯´æ˜"
            NOTES=$(cat RELEASE_NOTES.md)
          else
            echo "ç”Ÿæˆé»˜è®¤å‘å¸ƒè¯´æ˜"
            NOTES="Release ${{ steps.version.outputs.version }}"
          fi
          
          # ä½¿ç”¨å¤šè¡Œè¾“å‡º
          {
            echo 'notes<<EOF'
            echo "$NOTES"
            echo EOF
          } >> $GITHUB_OUTPUT

      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ steps.version.outputs.version }}
          body: |
            ${{ steps.release_notes.outputs.notes }}
            
            ## ğŸ“¦ ä¸‹è½½
            
            é€‰æ‹©é€‚åˆä½ ç³»ç»Ÿçš„ç‰ˆæœ¬ä¸‹è½½:
            
            ### Linux
            - [dudu-proxy-${{ steps.version.outputs.version }}-linux-amd64](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/dudu-proxy-${{ steps.version.outputs.version }}-linux-amd64)
            - [dudu-proxy-${{ steps.version.outputs.version }}-linux-arm64](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/dudu-proxy-${{ steps.version.outputs.version }}-linux-arm64)
            
            ### macOS
            - [dudu-proxy-${{ steps.version.outputs.version }}-darwin-amd64](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/dudu-proxy-${{ steps.version.outputs.version }}-darwin-amd64) (Intel)
            - [dudu-proxy-${{ steps.version.outputs.version }}-darwin-arm64](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/dudu-proxy-${{ steps.version.outputs.version }}-darwin-arm64) (Apple Silicon)
            
            ### Windows
            - [dudu-proxy-${{ steps.version.outputs.version }}-windows-amd64.exe](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/dudu-proxy-${{ steps.version.outputs.version }}-windows-amd64.exe)
            - [dudu-proxy-${{ steps.version.outputs.version }}-windows-arm64.exe](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/dudu-proxy-${{ steps.version.outputs.version }}-windows-arm64.exe)
            
            ## âœ… æ ¡éªŒå’ŒéªŒè¯
            
            ä¸‹è½½ [checksums.txt](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.version }}/checksums.txt) éªŒè¯æ–‡ä»¶å®Œæ•´æ€§:
            
            ```bash
            # Linux/macOS
            sha256sum -c checksums.txt
            
            # macOS (alternative)
            shasum -a 256 -c checksums.txt
            
            # Windows (PowerShell)
            Get-FileHash dudu-proxy-*.exe -Algorithm SHA256
            ```
          files: |
            release/*
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
